<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0">
    <title>Appendix & Data</title>
    <meta name="description" content="Explore a decade of philanthropy at The JPB Foundation. Discover grant allocations across program areas, visualize funding data, and track the growth of grants over time.">
    
    <!-- Optional: Open Graph tags for social sharing -->
    <meta property="og:title" content="Appendix & Data">
    <meta property="og:description" content="Explore a decade of philanthropy at The JPB Foundation. Discover grant allocations across program areas, visualize funding data, and track the growth of grants over time.">
    <meta property="og:type" content="website">

    <!-- Optional: Twitter Card tags -->
    <meta name="twitter:title" content="Appendix & Data">
    <meta name="twitter:description" content="Explore a decade of philanthropy at The JPB Foundation. Discover grant allocations across program areas, visualize funding data, and track the growth of grants over time.">

    <link rel="icon" type="image/png" sizes="32x32" href="assets/images/favicon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/images/favicon.png">
    <link rel="preload" href="assets/css/theme.css" as="style">
    <link rel="stylesheet" href="assets/css/theme.css">
    <link rel="preconnect" href="https://use.typekit.net">
    <link rel="preconnect" href="https://p.typekit.net">
    <link rel="stylesheet" href="https://use.typekit.net/aor8pib.css">
</head>
<body data-theme="green">
    <header id="header" class="header"></header>

    <script>
        fetch('partials/header.html')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.text();
            })
            .then(data => document.getElementById('header').innerHTML = data)
            .catch(error => console.error('Error loading header:', error));
    </script>

    <main class="site-main" role="main">
        <section class="hero-section subhero" role="banner">
            <div class="container hero-section__container center">

              <div class="hero-section__content">
                <h1 class="hero-section__title animate fade-up">
                  Appendix <br/>& Data
                </h1>
              </div>

            </div>
        </section>
        <section>
            <div class="container wide">
                <div class="section-header animate fade-up">
                    <h2>Grant Dollars per Program Area</h2>
                </div>
                <div class="chart-block doughnut">
                    <div class="chart-container">
                        <canvas id="grantChart" width="600" height="600"></canvas>
                        <div class="shade"></div>
                        <div class="textureOverlay"></div>
                        <div class="chartTotal"><label>Total:</label>$2,724,716,396</div>
                    </div>
                    <div class="custom-legend" id="legendContainer"></div>
                    <script>
                    document.addEventListener("DOMContentLoaded", function() {
                        // Data and Colors
                        const labels = [
                            'POVERTY',
                            'ENVIRONMENT',
                            'MEDICAL RESEARCH',
                            'EMERGENCY GRANTS',
                            'PRESIDENTâ€™S FUND',
                            'NON-PROGRAM',
                            'SECTOR SUPPORT'
                        ];

                        const data = [1148542592, 953107040, 268508274, 119658770, 114225000, 106255720, 14419000];
                        const colors = [
                            '#F47A5C', // Poverty
                            '#4AA14C', // Environment
                            '#3C84C5', // Medical Research
                            '#F7AC18', // Emergency Grants
                            '#F491A5', // President's Fund
                            '#2DA7B5', // Non-Program
                            '#CD5078'  // Sector Support
                        ];

                        let chartInitialized = false;
                        let texturePattern;
                        const textureImage = new Image();
                        textureImage.src = 'assets/images/texture.png'; // Adjust the path

                        // Plugin to draw texture on doughnut slices
                        const texturePlugin = {
                            id: 'texturePlugin',
                            afterDatasetsDraw: (chart) => {
                                if (!texturePattern) return;

                                const ctx = chart.ctx;
                                const dataset = chart.getDatasetMeta(0);

                                ctx.save();
                                dataset.data.forEach((arc) => {
                                    const model = arc;
                                    const centerX = model.x;
                                    const centerY = model.y;
                                    const innerRadius = model.innerRadius;
                                    const outerRadius = model.outerRadius;
                                    const startAngle = model.startAngle;
                                    const endAngle = model.endAngle;

                                    ctx.beginPath();

                                    // Draw doughnut slice path (arc from startAngle to endAngle)
                                    ctx.moveTo(centerX, centerY);
                                    ctx.arc(centerX, centerY, outerRadius, startAngle, endAngle);
                                    ctx.arc(centerX, centerY, innerRadius, endAngle, startAngle, true);
                                    ctx.closePath();

                                    // Set pattern fill style with some transparency
                                    ctx.fillStyle = texturePattern;
                                    ctx.globalAlpha = 0.6; // adjust transparency here

                                    ctx.fill();
                                });
                                ctx.restore();
                                ctx.globalAlpha = 1.0;
                            }
                        };

                        function initializeChart() {
                            if (chartInitialized) return;

                            const ctx = document.getElementById('grantChart').getContext('2d');
                            texturePattern = ctx.createPattern(textureImage, 'repeat');

                            new Chart(ctx, {
                                type: 'doughnut',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        data: data,
                                        backgroundColor: colors,
                                        hoverBackgroundColor: colors,
                                        borderWidth: 0
                                    }]
                                },
                                options: {
                                    cutout: '60%',
                                    plugins: {
                                        legend: { display: false },
                                        tooltip: {
                                            callbacks: {
                                                label: function(tooltipItem) {
                                                    const label = labels[tooltipItem.dataIndex].toUpperCase();
                                                    const value = `$${data[tooltipItem.dataIndex].toLocaleString()}`;
                                                    return [label + ":", value]; // Returning an array forces two lines
                                                },
                                                title: function() {
                                                    return ''; // Removes the default title
                                                }
                                            }
                                        }
                                    }
                                },
                                plugins: [texturePlugin]
                            });

                            // Custom Legend Creation
                            const legendContainer = document.getElementById('legendContainer');
                            legendContainer.innerHTML = ''; // Clear any existing legend items
                            labels.forEach((label, index) => {
                                const legendItem = document.createElement('div');
                                legendItem.classList.add('legend-item');
                                legendItem.innerHTML = `
                                    <div class="legend-color" style="background-color: ${colors[index]}"></div>
                                    <div class="wrap"><span class="title">${label}:</span> <span class="price">$${data[index].toLocaleString()}</span></div>
                                `;
                                legendContainer.appendChild(legendItem);
                            });

                            chartInitialized = true;
                        }

                        const isMobile = window.innerWidth <= 768;

                        // Intersection Observer to detect when the chart is in view
                        const observer = new IntersectionObserver((entries) => {
                            entries.forEach(entry => {
                                if (entry.isIntersecting) {
                                    if (textureImage.complete) {
                                        initializeChart();
                                    } else {
                                        textureImage.onload = initializeChart;
                                    }

                                    // Add class to the closest .chart-block
                                    const chartBlock = entry.target.closest('.chart-block');
                                    if (chartBlock) {
                                        chartBlock.classList.add('active');
                                    }

                                    observer.unobserve(entry.target);
                                }
                            });
                        }, { threshold: isMobile ? 0.2 : 0.5 });

                        observer.observe(document.getElementById('grantChart'));
                    });
                    </script>
                </div>
            </div>
        </section>

         <section>
            <div class="container wide">
                <div class="section-header animate fade-up">
                    <h2>Grant Dollars Over Time</h2>
                </div>
                <div class="chart-block bar-chart">
                    <div class="chart-container">
                        <canvas id="barChart" width="680" height="400"></canvas>
                        <div class="chartTotal relative bottom">Total: $2,724,716,396</div>
                    </div>
                </div>
            </div>
        </section>

         <section>
            <div class="container wide">
                <div class="section-header animate fade-up">
                    <h2>Number of Grants Over Time</h2>
                </div>
                <div class="chart-block bar-chart">
                    <div class="chart-container">
                        <canvas id="barChart2" width="680" height="400"></canvas>
                        <div class="chartTotal relative bottom">Total: 3894</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer id="footer" class="footer"></footer>
    <script>
    fetch('partials/footer.html')
        .then(response => response.ok ? response.text() : Promise.reject(response.status))
        .then(data => {
            const footer = document.getElementById('footer');
            if (footer) {
                footer.insertAdjacentHTML('beforeend', data);
            }
        });
    </script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="assets/js/custom-min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const createTexturePlugin = (textureVar) => ({
            id: `texturePlugin-${textureVar}`,
            afterDatasetsDraw: (chart) => {
                if (!window[textureVar]) return;
                const ctx = chart.ctx;
                const datasetMeta = chart.getDatasetMeta(0);
                ctx.save();
                datasetMeta.data.forEach(bar => {
                    const barWidth = bar.width;
                    const barHeight = bar.height;
                    const x = bar.x - barWidth / 2;
                    const y = bar.y;
                    ctx.globalAlpha = 0.7;
                    ctx.fillStyle = window[textureVar];
                    ctx.fillRect(x, y, barWidth, barHeight);
                    ctx.globalAlpha = 1.0;
                });
                ctx.restore();
            }
        });

        const lazyInitializeChart = (canvasId, chartInstanceVar, textureVar, imageSrc, chartColor, data, maxScale, isCurrency, dataSetLabel, stepSize) => {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            const isMobile = window.innerWidth <= 768;

            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const ctx = canvas.getContext('2d');
                        const img = new Image();
                        img.src = imageSrc;

                        img.onload = () => {
                            window[textureVar] = ctx.createPattern(img, 'repeat');
                            Chart.register(createTexturePlugin(textureVar));

                            window[chartInstanceVar] = new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels: ['2012', '2013', '2014', '2015', '2016', '2017', '2018', '2019', '2020', '2021', '2022', '2023'],
                                    datasets: [{
                                        label: dataSetLabel, 
                                        data: data,
                                        backgroundColor: chartColor,
                                        borderRadius: 0,
                                        clip: false,
                                    }]
                                },
                                options: {
                                    interaction: { mode: 'nearest', intersect: false },
                                    plugins: {
                                        legend: { 
                                            display: false,
                                            labels: {
                                                color: '#374151',
                                                font: {
                                                    size: 14,
                                                    family: 'proxima-nova, sans-serif',
                                                    weight: 700
                                                }
                                            }
                                        },
                                        tooltip: { 
                                            enabled: true, 
                                            position: 'nearest', 
                                            zIndex: 9999,
                                            callbacks: {
                                                label: function (tooltipItem) {
                                                    const label = tooltipItem.dataset.label || '';
                                                    const value = tooltipItem.raw.toLocaleString();
                                                    
                                                    // Format the label accordingly
                                                    return [`${label}:`, isCurrency ? `$${value}` : value];
                                                }
                                            }
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            max: maxScale,
                                            clip: false,
                                            ticks: {
                                                callback: v => {
                                                    if (v === 0) return '';
                                                    return isCurrency ? `$${(v / 1000000).toFixed(0)}M` : `${v}`;
                                                },
                                                stepSize: stepSize,
                                                color: '#374151',
                                                font: { size: 15, family: 'proxima-nova, sans-serif', weight: 700 }
                                            },
                                            grid: { color: 'rgba(62,102,148,0.5)', drawBorder: false, drawTicks: false },
                                            border: { display: false }
                                        },
                                        x: {
                                            clip: false,
                                            ticks: {
                                                color: '#374151',
                                                font: { size: 15, family: 'proxima-nova, sans-serif', weight: 700 },
                                                padding: 10
                                            },
                                            grid: { display: false, drawBorder: false, drawOnChartArea: false, drawTicks: false },
                                            border: { display: true, color: 'rgba(62,102,148,0.5)', width: 2 }
                                        }
                                    },
                                    onResize: (chart, size) => {
                                        chart.options.scales.x.ticks.font.size = size.width < 576 ? 11 : 15;
                                        chart.options.scales.y.ticks.font.size = size.width < 576 ? 11 : 15;
                                        chart.update();
                                    },
                                    animation: {
                                        duration: 1000,
                                        easing: 'easeOutCubic'
                                    }
                                }
                            });
                        };

                        img.onerror = () => console.error("Failed to load texture image.");

                        obs.unobserve(entry.target); // Stop observing after initialization
                    }
                });
            }, {
                threshold: isMobile ? 0.2 : 0.5
            });

            observer.observe(canvas);
        };

        // Call for both charts with dynamic labels
        lazyInitializeChart('barChart', 'chartInstance', 'texture', 'assets/images/texture.png', '#2DA7B5', [46873129, 78051333, 117636163, 149203479, 170916664, 206214509, 229072720, 263891499, 359985747, 318798612, 359631836, 424440705],
            500000000, true, "Payment Amount", 100000000);
        lazyInitializeChart('barChart2', 'chartInstance2', 'texture2', 'assets/images/texture.png', '#3E6695', [100, 141, 186, 199, 263, 317, 336, 386, 476, 475, 464, 551], 600, false, "Number of Grants", 100);

    });
    </script>
</body>
</html>
